image: Visual Studio 2017
clone_depth: 5
platform: Any CPU
configuration: Release

assembly_info:
  patch: true
  file: AssemblyInfo.*
  assembly_version: "{version}"
  assembly_file_version: "{version}"
  assembly_informational_version: "{version}"

init:
  # Set version number
  - ps: >-
      $commitHashInt = [Int32]::Parse($($env:APPVEYOR_REPO_COMMIT.Substring(0,7)), [System.Globalization.NumberStyles]::HexNumber)
      if ($env:APPVEYOR_REPO_TAG -eq "true")
      {
        Update-AppveyorBuild -Version "$($env:APPVEYOR_REPO_TAG_NAME.TrimStart("v.")).$commitHashInt"
        $wc = New-Object 'System.Net.WebClient'
        $wc.UploadString("https://ci.appveyor.com/api/projects", "PUT", "{"projectId":43682, "accountName":"appvyr", "versionFormat":"$($env:APPVEYOR_REPO_TAG_NAME.TrimStart("v.")).{build}",}")
        $wc.UploadString("/api/projects/{accountName}/{projectSlug}/settings/build-number", "PUT", "{ nextBuildNumber: 5 }")
      }
      else
      {
        Update-AppveyorBuild -Version "$($env:APPVEYOR_BUILD_VERSION).$commitHashInt"
      }

before_build:
  - cmd: nuget restore .\DryIoc.Wcf.sln -Verbosity detailed

build:
  parallel: false
  project: .\DryIoc.Wcf.sln
  verbosity: detailed
  
test_script:
    - ps: .\run-tests.ps1

cache:
  - packages -> **\packages.config

artifacts:
  - path: '.\DryIoc.Wcf\bin\Release\DryIoc.Wcf.dll.*.nupkg'
    name: nuget
    type: NuGetPackage

deploy:
  - provider: NuGet
    api_key:
      secure: LKL3BM5Iphp+fjoZzhqLAMrQOLrNXvY4tEEa5zRKpTY2Ti4gOzBUhxaprnCzfTO3
    skip_symbols: false
    artifact: /.*\.nupkg/
    on:
      appveyor_repo_tag: true
  - provider: GitHub
    description: 'Release'
    release: $(appveyor_build_version)
    auth_token:
      secure: K71ovddtT7BuOR1D1K9uVRdOT2+Apl6GdQjBYjUki/ySUX9EcWb2MNtupx5ymrkt
    artifact: /.*\.nupkg/
    on:
      appveyor_repo_tag: true 